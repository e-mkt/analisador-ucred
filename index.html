<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ucred · Analisador</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.1/dist/css/tabulator.min.css" rel="stylesheet">

  <style>
    :root{
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, system-ui, sans-serif;

      --bg: #f3f6fb;
      --text: #0b1220;
      --muted: rgba(11,18,32,.62);
      --muted2: rgba(11,18,32,.48);

      --card: rgba(255,255,255,.92);
      --cardSolid: #ffffff;

      --border: rgba(11,18,32,.10);
      --border2: rgba(11,18,32,.08);

      --shadow: 0 18px 60px rgba(17,24,39,.10);
      --shadow2: 0 10px 30px rgba(17,24,39,.08);

      --headerBg: rgba(255,255,255,.78);
      --headerBorder: rgba(11,18,32,.10);

      --pillBg: rgba(11,18,32,.06);
      --pillText: rgba(11,18,32,.58);

      --okBg: rgba(19, 160, 92, .12);
      --okText: rgba(19, 160, 92, .95);

      --warnBg: rgba(245, 158, 11, .18);
      --warnText: rgba(245, 158, 11, .98);

      --badBg: rgba(239, 68, 68, .14);
      --badText: rgba(239, 68, 68, .98);

      --kpiWin: rgba(17, 160, 90, .95);
      --kpiLoss: rgba(239, 68, 68, .95);

      --rateWinTint: rgba(17, 160, 90, .62);
      --rateLossTint: rgba(239, 68, 68, .62);

      --blue: rgba(59, 130, 246, .42);
      --blueLine: rgba(59, 130, 246, .95);

      --pink: rgba(244, 114, 182, .42);
      --pinkLine: rgba(244, 114, 182, .95);

      --amber: rgba(245, 158, 11, .28);
      --amberLine: rgba(245, 158, 11, .90);

      --grid: rgba(11,18,32,.12);
      --axis: rgba(11,18,32,.55);

      --anchorOffset: 92px; /* recalculado via JS */
      --radiusXL: 28px;
      --radiusL: 22px;
      --radiusM: 16px;

      --tap: 44px;
    }

    html.dark{
      --bg: #0f141b;              /* menos “preto puro” */
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.48);

      --card: rgba(19, 26, 36, .72);
      --cardSolid: #131a24;

      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.07);

      --shadow: 0 20px 80px rgba(0,0,0,.45);
      --shadow2: 0 12px 40px rgba(0,0,0,.35);

      --headerBg: rgba(12, 16, 23, .72);
      --headerBorder: rgba(255,255,255,.10);

      --pillBg: rgba(255,255,255,.08);
      --pillText: rgba(255,255,255,.62);

      --okBg: rgba(19, 160, 92, .16);
      --okText: rgba(43, 230, 140, .90);

      --warnBg: rgba(245, 158, 11, .22);
      --warnText: rgba(255, 196, 92, .95);

      --badBg: rgba(239, 68, 68, .20);
      --badText: rgba(255, 120, 120, .95);

      --kpiWin: rgba(43, 230, 140, .95);
      --kpiLoss: rgba(255, 120, 120, .95);

      --rateWinTint: rgba(43, 230, 140, .62);
      --rateLossTint: rgba(255, 120, 120, .62);

      --blue: rgba(59, 130, 246, .38);
      --blueLine: rgba(96, 165, 250, .98);

      --pink: rgba(244, 114, 182, .36);
      --pinkLine: rgba(251, 113, 133, .95);

      --amber: rgba(245, 158, 11, .24);
      --amberLine: rgba(245, 158, 11, .90);

      --grid: rgba(255,255,255,.10);
      --axis: rgba(255,255,255,.58);
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Evita “camadas repetidas” abaixo do rodapé */
    body::before{
      content:"";
      position: fixed;
      inset: 0 0 auto 0;
      height: 520px;
      pointer-events: none;
      z-index: -1;
      background:
        radial-gradient(900px 320px at 50% 0%, rgba(16,185,129,.12), transparent 60%),
        radial-gradient(800px 280px at 20% 0%, rgba(59,130,246,.10), transparent 62%),
        radial-gradient(900px 300px at 80% 0%, rgba(244,114,182,.08), transparent 62%);
      opacity: .85;
    }
    html.dark body::before{
      opacity: .55;
      background:
        radial-gradient(900px 320px at 50% 0%, rgba(16,185,129,.16), transparent 60%),
        radial-gradient(800px 280px at 20% 0%, rgba(59,130,246,.14), transparent 62%),
        radial-gradient(900px 300px at 80% 0%, rgba(244,114,182,.10), transparent 62%);
    }

    a{ color: inherit; text-decoration: none; }
    button, input, select{ font-family: var(--font); }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 18px 28px;
    }

    /* Header */
    .topbarWrap{
      position: sticky;
      top: 16px;
      z-index: 50;
      padding: 16px 18px 0;
    }
    .topbar{
      max-width: 1180px;
      margin: 0 auto;
      border-radius: 999px;
      border: 1px solid var(--headerBorder);
      background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.68));
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 12px 14px;
      display: grid;
      grid-template-columns: 220px 1fr 220px;
      align-items: center;
      gap: 10px;
    }
    html.dark .topbar{
      background: linear-gradient(180deg, rgba(10,14,20,.82), rgba(10,14,20,.62));
    }

    .brand{
      display: flex;
      align-items: center;
      gap: 10px;
      padding-left: 8px;
      min-width: 0;
    }
    .brand img{
      height: 28px;
      width: auto;
      display: block;
    }

    .nav{
      display: flex;
      justify-content: center;
      gap: 26px;
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
    }
    .nav a{
      padding: 8px 10px;
      border-radius: 999px;
      transition: background .18s ease, color .18s ease, transform .18s ease;
    }
    .nav a:hover{
      background: rgba(127,127,127,.10);
      color: var(--text);
      transform: translateY(-1px);
    }

    .topbarRight{
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 6px;
    }

    .themeBtn{
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(127,127,127,.10);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform .18s ease, background .18s ease;
    }
    .themeBtn:hover{ transform: translateY(-1px) scale(1.03); background: rgba(127,127,127,.14); }
    .themeBtn svg{ width: 18px; height: 18px; opacity: .85; }

    /* Cards */
    .card{
      background: var(--card);
      border: 1px solid var(--border2);
      border-radius: var(--radiusXL);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .section{
      scroll-margin-top: var(--anchorOffset);
      margin-top: 18px;
    }
    .sectionPad{ padding: 22px 22px; }

    .heroTitle{
      font-size: 42px;
      line-height: 1.08;
      margin: 0 0 10px;
      letter-spacing: -.02em;
    }
    .heroSub{
      margin: 0;
      color: var(--muted);
      font-size: 18px;
      line-height: 1.45;
      max-width: 900px;
    }

    /* Section header row */
    .sectionHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 14px;
    }
    .sectionLabel{
      font-size: 14px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--muted2);
      font-weight: 800;
    }

    /* Pills */
    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 700;
      border: 1px solid transparent;
      user-select: none;
      white-space: nowrap;
    }
    /* Auto pill mais leve (pedido do print 1) */
    .pillAuto{
      background: rgba(127,127,127,.10);
      color: rgba(127,127,127,.72);
      font-weight: 600;
      border: none;
      padding: 7px 12px;
    }
    html.dark .pillAuto{
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.58);
    }

    .pillOk{ background: var(--okBg); color: var(--okText); }
    .pillWarn{ background: var(--warnBg); color: var(--warnText); }
    .pillBad{ background: var(--badBg); color: var(--badText); }

    /* Buttons */
    .btn{
      height: var(--tap);
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(127,127,127,.08);
      color: var(--text);
      font-weight: 800;
      padding: 0 16px;
      cursor: pointer;
      transition: transform .18s ease, background .18s ease, box-shadow .18s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .btn:hover{
      transform: translateY(-1px) scale(1.02);
      background: rgba(127,127,127,.12);
      box-shadow: 0 10px 24px rgba(0,0,0,.10);
    }
    .btnPrimary{
      background: rgba(16,185,129,.14);
      border-color: rgba(16,185,129,.30);
    }
    .btnPrimary:hover{ background: rgba(16,185,129,.18); }
    .btnGhost{
      background: transparent;
    }
    .btnIcon svg{ width: 16px; height: 16px; opacity: .75; }

    .btnRow{
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    /* Uploads - layout mais equilibrado */
    .uploadsShell{
      display: grid;
      gap: 14px;
    }
    .uploadsTopRow{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .uploadsMsg{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border: 1px solid var(--border2);
      border-radius: 18px;
      background: rgba(127,127,127,.06);
    }
    .uploadsMsg strong{ font-size: 16px; }
    .uploadsMsg span{ color: var(--muted); font-weight: 650; }

    .uploadsGrid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .topbar{ grid-template-columns: 1fr; row-gap: 10px; padding: 14px; border-radius: 26px; }
      .brand{ justify-content: center; padding-left: 0; }
      .nav{ justify-content: center; flex-wrap: wrap; gap: 10px; }
      .topbarRight{ justify-content: center; padding-right: 0; }
      .uploadsGrid{ grid-template-columns: 1fr; }
      .filtersGrid{ grid-template-columns: 1fr !important; }
      .kpiGrid{ grid-template-columns: 1fr 1fr !important; }
      .chartsGrid{ grid-template-columns: 1fr !important; }
    }

    .uploadBox{
      border: 1px dashed var(--border);
      border-radius: 22px;
      padding: 16px 16px;
      background: rgba(127,127,127,.04);
      display: grid;
      gap: 10px;
      min-height: 140px;
    }

    /* títulos menores e mais “apple style” (pedido do print 6) */
    .uploadBox h3{
      margin: 0;
      font-size: 16px;
      letter-spacing: -.01em;
      font-weight: 850;
    }
    .uploadHelp{
      margin: 0;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* File input “Apple style” */
    .fileRow{
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: center;
    }
    .fileBtn{
      height: 38px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(127,127,127,.10);
      font-weight: 800;
      padding: 0 14px;
      cursor: pointer;
      transition: transform .18s ease, background .18s ease;
      white-space: nowrap;
    }
    .fileBtn:hover{ transform: translateY(-1px) scale(1.02); background: rgba(127,127,127,.14); }
    .fileName{
      height: 38px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(127,127,127,.06);
      display: flex;
      align-items: center;
      padding: 0 14px;
      color: var(--muted);
      font-weight: 650;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    input[type="file"]{
  position: absolute !important;
  left: -9999px !important;
  width: 1px !important;
  height: 1px !important;
  opacity: 0 !important;
}

    /* Results / Filters */
    .filtersGrid{
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      align-items: end;
      margin-top: 8px;
    }

    /* labels menores, com respiro e alinhados com o select (pedido do print 3) */
    .field label{
      display: block;
      font-size: 13px;
      font-weight: 800;
      color: var(--muted);
      margin: 0 0 8px 10px;
    }
    .select{
      width: 100%;
      height: 52px;
      border-radius: 18px;
      border: 1px solid var(--border2);
      background: rgba(127,127,127,.06);
      padding: 0 14px;
      font-size: 16px;
      font-weight: 750;
      color: var(--text);
      outline: none;
    }
    .select:focus{
      border-color: rgba(59,130,246,.38);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    .kpiGrid{
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
      margin-top: 14px;
    }
    .kpi{
      border: 1px solid var(--border2);
      border-radius: 24px;
      padding: 18px 18px;
      background: rgba(127,127,127,.05);
      transition: transform .18s ease, box-shadow .18s ease;
      min-height: 120px;
    }
    .kpi:hover{
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 18px 36px rgba(0,0,0,.12);
    }
    .kpi .t{ color: var(--muted); font-weight: 900; font-size: 18px; }
    .kpi .v{
      margin-top: 8px;
      font-size: 44px;
      font-weight: 950;
      letter-spacing: -.03em;
    }
    .kpi .s{ margin-top: 8px; color: var(--muted); font-weight: 700; }

    .kpi .vRow{
      display: flex;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
    }
    .kpi .vMain{ font-size: 44px; font-weight: 950; letter-spacing: -.03em; }
    .kpi .vRate{
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -.01em;
    }
    .kpi .vRate.win{ color: var(--rateWinTint); }
    .kpi .vRate.loss{ color: var(--rateLossTint); }

    /* Insights grid alignment: 3 colunas, 3 linhas, alturas “casadas” */
    .triHeader{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
      margin-top: 16px;
      align-items: center;
    }
    .triHeader .h{
      font-size: 13px;
      letter-spacing: .14em;
      text-transform: uppercase;
      font-weight: 900;
      color: var(--muted2);
      padding-left: 6px;
    }

    .triGrid{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-auto-flow: row;
      grid-auto-rows: 1fr; /* força mesma altura por linha */
      gap: 14px;
      margin-top: 10px;
      align-items: stretch;
    }

    @media (max-width: 980px){
      .triHeader{ display:none; }
      .triGrid{ grid-template-columns: 1fr; }
    }

    .miniCard{
      border-radius: 26px;
      border: 1px solid var(--border2);
      background: rgba(127,127,127,.05);
      padding: 16px 16px;
      box-shadow: 0 12px 24px rgba(0,0,0,.06);
      transition: transform .18s ease, box-shadow .18s ease;
      display: grid;
      grid-template-rows: auto auto 1fr;
      min-height: 208px;
    }
    .miniCard:hover{
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 18px 36px rgba(0,0,0,.12);
    }
    .miniTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .miniTitle{
      font-size: 18px;
      font-weight: 950;
      letter-spacing: -.02em;
      margin: 0;
      line-height: 1.15;
    }
    .miniSub{
      margin: 4px 0 0;
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
      line-height: 1.25;
    }
    .badgeRate{
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .badgeWin{ background: rgba(16,185,129,.12); border-color: rgba(16,185,129,.22); color: var(--kpiWin); }
    .badgeLoss{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.22); color: var(--kpiLoss); }

    .statsGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-content: stretch;
      position: relative;
    }

    .statBox{
      border-radius: 18px;
      border: 1px solid var(--border2);
      background: rgba(127,127,127,.04);
      padding: 12px 12px;
      min-height: 76px;
      cursor: pointer;
      position: relative;
      perspective: 800px;
      transition: transform .18s ease, box-shadow .18s ease;
      overflow: hidden;
    }
    .statBox:hover{
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 14px 26px rgba(0,0,0,.10);
    }
    .statBox .infoDot{
      position: absolute;
      top: 10px; right: 10px;
      width: 18px; height: 18px;
      border-radius: 999px;
      display:grid; place-items:center;
      font-size: 12px;
      font-weight: 900;
      background: rgba(127,127,127,.12);
      color: rgba(127,127,127,.85);
      opacity: 0;
      transform: translateY(-2px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events: none;
    }
    .statBox:hover .infoDot{
      opacity: 1;
      transform: translateY(0);
    }

    .statInner{
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform .34s cubic-bezier(.2,.9,.2,1);
    }
    .statFront, .statBack{
      position:absolute;
      inset:0;
      backface-visibility: hidden;
    }
    .statBack{
      transform: rotateY(180deg);
      padding: 12px 12px;
      display:grid;
      align-content:start;
      gap: 8px;
    }
    .statLabel{
      color: var(--muted);
      font-weight: 850;
      font-size: 13px;
    }
    .statValue{
      font-weight: 950;
      font-size: 24px;
      letter-spacing: -.02em;
      margin-top: 2px;
    }
    .statBack p{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      font-weight: 650;
    }

    /* Expansão para ocupar os 4 boxes (pedido anterior: “não estourar”) */
    .miniCard.expanded .statBox{ opacity: 0; pointer-events: none; transform:none; box-shadow:none; }
    .miniCard.expanded .statBox.active{
      opacity: 1;
      pointer-events: auto;
      grid-column: 1 / -1;
      grid-row: 1 / -1;
      min-height: 168px;
    }
    .miniCard.expanded .statBox.active .statInner{ transform: rotateY(180deg); }
    .miniCard.expanded .statBox.active .infoDot{ opacity: 0; }

    /* Charts */
    .chartsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 8px;
    }
    .chartCard{
      border-radius: 26px;
      border: 1px solid var(--border2);
      background: rgba(127,127,127,.05);
      padding: 16px 16px;
      overflow: hidden;
    }
    .chartTitleRow{
      display:flex;
      align-items:baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .chartTitle{
      margin: 0;
      font-weight: 950;
      letter-spacing: -.02em;
      font-size: 18px;
    }
    .chartHint{
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }
    .chartCanvasWrap{
      border-radius: 22px;
      border: 1px solid var(--border2);
      background: rgba(127,127,127,.03);
      padding: 10px;
    }
    canvas{ width: 100% !important; height: 320px !important; }

    /* Custom tooltip */
    .chart-tooltip{
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      background: rgba(17, 24, 39, .92);
      color: rgba(255,255,255,.95);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      transform: translate(-50%, calc(-100% - 14px));
      transition: left .12s ease, top .12s ease, opacity .12s ease;
      opacity: 0;
      max-width: 320px;
      width: fit-content;
    }
    .ct-title{
      font-weight: 950;
      font-size: 18px;
      letter-spacing: -.02em;
      margin-bottom: 6px;
      white-space: nowrap;
    }
    .ct-row{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 750;
      margin: 4px 0;
      white-space: nowrap;
    }
    .ct-swatch{
      width: 14px; height: 14px;
      border-radius: 3px;
      border: 1px solid rgba(255,255,255,.22);
      flex: 0 0 auto;
    }
    .ct-row b{ font-weight: 950; }

    /* Table */
    .tableTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .search{
      flex: 1 1 320px;
      height: 48px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(127,127,127,.06);
      padding: 0 14px;
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
      outline:none;
    }
    .search::placeholder{ color: var(--muted2); font-weight: 650; }
    .rowsSelWrap{
      display:flex;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
    }
    .rowsSel{
      height: 44px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(127,127,127,.06);
      padding: 0 12px;
      font-weight: 850;
      color: var(--text);
      outline:none;
    }
    .tableHint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 650;
      padding-left: 6px;
    }

    /* Tabulator theming */
    .tabulator{
      border: 1px solid var(--border2) !important;
      border-radius: 22px;
      overflow: hidden;
      background: transparent !important;
      font-family: var(--font) !important;
    }
    .tabulator .tabulator-header{
      background: rgba(127,127,127,.14) !important; /* melhora no dark */
      border-bottom: 1px solid var(--border2) !important;
      color: var(--text) !important;
    }
    html.dark .tabulator .tabulator-header{
      background: rgba(255,255,255,.08) !important;
    }
    .tabulator .tabulator-header .tabulator-col{
      background: transparent !important;
      border-right: 1px solid var(--border2) !important;
    }
    .tabulator .tabulator-row{
      background: rgba(127,127,127,.02) !important;
      border-bottom: 1px solid var(--border2) !important;
    }
    html.dark .tabulator .tabulator-row{
      background: rgba(255,255,255,.03) !important;
    }
    .tabulator .tabulator-row:nth-child(even){
      background: rgba(127,127,127,.04) !important;
    }
    html.dark .tabulator .tabulator-row:nth-child(even){
      background: rgba(255,255,255,.05) !important;
    }
    .tabulator .tabulator-cell{
      border-right: 1px solid var(--border2) !important;
      color: var(--text) !important;
      font-weight: 650;
    }
    .tabulator .tabulator-footer{ display:none !important; } /* remove paginação (pedido do print 5) */

    /* Footer */
    footer{
      padding: 18px 0 28px;
      color: var(--muted);
      text-align: center;
      font-weight: 700;
      font-size: 13px;
    }
    .footerBrand{
      margin-top: 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }
    .footerBrand img{
      height: 18px;
      width: auto;
      display:block;
    }

    /* Small helper */
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="topbarWrap">
    <header class="topbar" id="topbar">
      <div class="brand">
        <img id="logoUcred" alt="Ucred" src="./assets/img/logo-ucred-light.png">
      </div>

      <nav class="nav" aria-label="Seções">
        <a href="#uploads">Uploads</a>
        <a href="#results">Resultados</a>
        <a href="#insights">Insights</a>
        <a href="#charts">Gráficos</a>
        <a href="#table">Tabela</a>
      </nav>

      <div class="topbarRight">
        <button class="themeBtn" id="themeToggle" aria-label="Alternar tema">
          <!-- ícone será trocado via JS -->
          <svg id="themeIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 13.5a8.5 8.5 0 1 1-10.5-10A7 7 0 0 0 21 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </header>
  </div>

  <main class="wrap">
    <section class="card section sectionPad" aria-label="Introdução">
      <h1 class="heroTitle">Performance por região</h1>
      <p class="heroSub">
        Analise onde você <b>ganha</b> e <b>perde</b> por Região, Estado, Microrregião e Cidade.
        O IBGE pode ser aplicado automaticamente. Se quiser, use um mapa interno para clusters próprios.
      </p>
    </section>

    <!-- Uploads -->
    <section class="card section sectionPad" id="uploads">
      <div class="sectionHeader">
        <div class="sectionLabel">Uploads</div>
        <button class="btn btnGhost" id="toggleUploads">Editar uploads</button>
      </div>

      <div class="uploadsShell">
        <div class="uploadsMsg" id="uploadsMsg">
          <div>
            <strong id="uploadsMsgTitle">Pronto</strong>
            <span id="uploadsMsgText">carregue uma base ou veja a demo</span>
          </div>
          <span class="pill pillOk" id="uploadsPill">ok</span>
        </div>

        <div class="uploadsGrid" id="uploadsDetails">
          <div class="uploadBox">
            <h3>Base CRM (CSV/XLSX)</h3>
            <div class="fileRow">
              <button class="fileBtn" id="basePickBtn">Selecionar arquivo</button>
              <div class="fileName" id="baseFileName">Nenhum arquivo selecionado</div>
              <input id="baseFile" type="file" accept=".csv,.xlsx,.xls">
            </div>
            <p class="uploadHelp">
              Colunas aceitas (obrigatórias): <b>Cidade</b>, <b>Estado</b>, <b>Data de criação</b>, <b>Vendas</b>, <b>Perdidos</b>, <b>Em andamento</b>, <b>Pausados</b>.<br>
              Colunas opcionais: <b>ID (opcional)</b>, <b>Nome (opcional)</b>. Outras colunas serão ignoradas.
            </p>
          </div>

          <div class="uploadBox">
            <h3>Mapa interno (opcional)</h3>
            <div class="fileRow">
              <button class="fileBtn" id="mapPickBtn">Selecionar arquivo</button>
              <div class="fileName" id="mapFileName">Nenhum arquivo selecionado</div>
              <input id="mapFile" type="file" accept=".csv,.xlsx,.xls">
            </div>
            <p class="uploadHelp">
              Colunas aceitas (obrigatórias): <b>cidade</b>, <b>uf</b>, <b>microrregiao</b>.<br>
              Coluna opcional: <b>regiao (opcional)</b>. Outras colunas serão ignoradas.
            </p>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn btnPrimary" id="analyzeBtn">Ver demo</button>

          <button class="btn btnIcon" id="tplBaseBtn" title="Baixar template de base">
            <span class="btnIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M8 11l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 19h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            Template de base
          </button>

          <button class="btn btnIcon" id="tplMapBtn" title="Baixar template de mapa">
            <span class="btnIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M8 11l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 19h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            Template de mapa
          </button>

          <button class="btn" id="clearAllBtn">Limpar</button>
        </div>
      </div>
    </section>

    <!-- Resultados -->
    <section class="card section sectionPad" id="results">
      <div class="sectionHeader">
        <div class="sectionLabel">Resultados</div>
        <div class="btnRow">
          <button class="btn" id="clearFiltersBtn">Limpar filtros</button>
          <button class="btn" id="downloadSummaryBtn">Baixar resumo</button>
          <button class="btn" id="downloadCitiesBtn">Baixar cidades</button>
        </div>
      </div>

      <div class="filtersGrid">
        <div class="field">
          <label for="monthFilter">Mês</label>
          <select class="select" id="monthFilter"></select>
        </div>
        <div class="field">
          <label for="regionFilter">Região</label>
          <select class="select" id="regionFilter"></select>
        </div>
        <div class="field">
          <label for="ufFilter">Estado</label>
          <select class="select" id="ufFilter"></select>
        </div>
        <div class="field">
          <label for="rateBaseFilter">Base da taxa</label>
          <select class="select" id="rateBaseFilter">
            <option value="closed">Fechadas (Vendas + Perdidos)</option>
            <option value="total">Total (inclui Em negociação)</option>
          </select>
        </div>
      </div>

      <div class="kpiGrid" id="kpiGrid"></div>
    </section>

    <!-- Insights -->
    <section class="card section sectionPad" id="insights">
      <div class="sectionHeader">
        <div class="sectionLabel">Insights</div>
      </div>

      <div class="triHeader" aria-hidden="true">
        <div class="h">Oportunidades</div>
        <div class="h">Riscos</div>
        <div class="h">Insights automáticos</div>
      </div>

      <div class="triGrid" id="triGrid"></div>
    </section>

    <!-- Charts -->
    <section class="card section sectionPad" id="charts">
      <div class="sectionHeader">
        <div class="sectionLabel">Gráficos</div>
      </div>

      <div class="chartsGrid">
        <div class="chartCard">
          <div class="chartTitleRow">
            <div>
              <h3 class="chartTitle" id="chartRegionTitle">Volume por Região <span class="chartHint">(clique para filtrar)</span></h3>
              <div class="chartHint" id="chartRegionClearWrap" style="margin-top:4px; display:none;">
                <a href="#" id="chartRegionClear" style="text-decoration: underline; font-weight:650; opacity:.8;">Remover filtro</a>
              </div>
            </div>
          </div>
          <div class="chartCanvasWrap"><canvas id="chartRegion"></canvas></div>
        </div>

        <div class="chartCard">
          <div class="chartTitleRow">
            <h3 class="chartTitle">Taxa de ganho por Região</h3>
          </div>
          <div class="chartCanvasWrap"><canvas id="chartWinRateRegion"></canvas></div>
        </div>

        <div class="chartCard">
          <div class="chartTitleRow">
            <h3 class="chartTitle">Volume por Estado</h3>
          </div>
          <div class="chartCanvasWrap"><canvas id="chartUF"></canvas></div>
        </div>

        <div class="chartCard">
          <div class="chartTitleRow">
            <h3 class="chartTitle">Evolução mensal (Ganhas x Perdidos)</h3>
          </div>
          <div class="chartCanvasWrap"><canvas id="chartMonthly"></canvas></div>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="card section sectionPad" id="table">
      <div class="sectionHeader">
        <div class="sectionLabel">Tabela</div>
      </div>

      <div class="tableTop">
        <input class="search" id="tableSearch" placeholder="Buscar cidade, microrregião, estado ou região...">
        <div class="rowsSelWrap">
          Exibir
          <select class="rowsSel" id="rowsSelect">
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
          linhas
        </div>
      </div>

      <div id="citiesTable"></div>
      <div class="tableHint" id="tableHint">Dica: use a busca acima e/ou os filtros no cabeçalho das colunas.</div>
    </section>

    <footer>
      Desenvolvido por
      <div class="footerBrand">
        <img id="logoEmkt" alt="eMKT" src="./assets/img/logo-emkt-light.png">
      </div>
    </footer>
  </main>

  <div id="chartTooltip" class="chart-tooltip"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>

  <script>
    /********************
     * Theme + assets
     ********************/
    const ASSETS = {
      ucredLight: "./assets/img/logo-ucred-light.png",
      ucredDark:  "./assets/img/logo-ucred-dark.png",
      emktLight:  "./assets/img/logo-emkt-light.png",
      emktDark:   "./assets/img/logo-emkt-dark.png",
      demoCsv:    "./assets/demo/rd_demo.csv"
    };

    const $ = (sel, root=document) => root.querySelector(sel);

    const themeToggle = $("#themeToggle");
    const themeIcon = $("#themeIcon");
    const logoUcred = $("#logoUcred");
    const logoEmkt = $("#logoEmkt");

    function setTheme(mode){
      const isDark = mode === "dark";
      document.documentElement.classList.toggle("dark", isDark);
      try { localStorage.setItem("ucred_theme", mode); } catch(e) {}

      logoUcred.src = isDark ? ASSETS.ucredDark : ASSETS.ucredLight;
      logoEmkt.src  = isDark ? ASSETS.emktDark  : ASSETS.emktLight;

      // ícone
      themeIcon.innerHTML = isDark
        ? '<path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12Z" stroke="currentColor" stroke-width="2"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>'
        : '<path d="M21 13.5a8.5 8.5 0 1 1-10.5-10A7 7 0 0 0 21 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';

      applyThemeToCharts();
      applyThemeToTable();
    }

    themeToggle.addEventListener("click", () => {
      const isDark = document.documentElement.classList.contains("dark");
      setTheme(isDark ? "light" : "dark");
    });

    let savedTheme = "light";
try { savedTheme = localStorage.getItem("ucred_theme") || "light"; } catch(e) {}
setTheme(savedTheme);

    /********************
     * Anchor offset calibration (menos “espaço sobrando”)
     ********************/
    function calibrateAnchorOffset(){
      const header = $("#topbar");
      const wrap = $(".topbarWrap");
      const headerH = header.getBoundingClientRect().height;
      const topOffset = parseFloat(getComputedStyle(wrap).top || "16") || 16;
      // antes estava grande: agora “justo” (header + offset + ~14)
      const offset = Math.round(headerH + topOffset + 14);
      document.documentElement.style.setProperty("--anchorOffset", offset + "px");
    }
    window.addEventListener("resize", calibrateAnchorOffset);
    calibrateAnchorOffset();

    /********************
     * Uploads state
     ********************/
    const uploadsMsgTitle = $("#uploadsMsgTitle");
    const uploadsMsgText  = $("#uploadsMsgText");
    const uploadsPill     = $("#uploadsPill");

    function setUploadsStatus(kind, title, text){
      uploadsMsgTitle.textContent = title || "";
      uploadsMsgText.textContent  = text || "";
      uploadsPill.classList.remove("pillOk","pillWarn","pillBad");
      if(kind === "ok"){ uploadsPill.classList.add("pillOk"); uploadsPill.textContent = "ok"; }
      if(kind === "warn"){ uploadsPill.classList.add("pillWarn"); uploadsPill.textContent = "aguarde"; }
      if(kind === "bad"){ uploadsPill.classList.add("pillBad"); uploadsPill.textContent = "atenção"; }
    }

    /********************
     * Upload UI
     ********************/
    const uploadsDetails = $("#uploadsDetails");
    const toggleUploads  = $("#toggleUploads");

    let uploadsOpen = true;
    function setUploadsOpen(open){
      uploadsOpen = open;
      uploadsDetails.style.display = open ? "grid" : "none";
      toggleUploads.textContent = open ? "Fechar uploads" : "Editar uploads";
      calibrateAnchorOffset();
    }
    toggleUploads.addEventListener("click", () => setUploadsOpen(!uploadsOpen));

    // Default: aberto para facilitar primeiro uso
    setUploadsOpen(true);

    const baseFileInput = $("#baseFile");
    const mapFileInput  = $("#mapFile");
    const basePickBtn   = $("#basePickBtn");
    const mapPickBtn    = $("#mapPickBtn");
    const baseFileName  = $("#baseFileName");
    const mapFileName   = $("#mapFileName");

    basePickBtn.addEventListener("click", () => baseFileInput.click());
    mapPickBtn.addEventListener("click", () => mapFileInput.click());

    baseFileInput.addEventListener("change", () => {
      const f = baseFileInput.files?.[0];
      baseFileName.textContent = f ? f.name : "Nenhum arquivo selecionado";
      state.hasUserBase = !!f;
      syncActionButtons();
      // ao selecionar base, não roda automaticamente; só atualiza status
      if(f){
        setUploadsStatus("ok", "Pronto", "arquivo selecionado — clique em Analisar dados");
      }else{
        setUploadsStatus("ok", "Pronto", "carregue uma base ou veja a demo");
      }
    });

    mapFileInput.addEventListener("change", () => {
      const f = mapFileInput.files?.[0];
      mapFileName.textContent = f ? f.name : "Nenhum arquivo selecionado";
      if(f){
        setUploadsStatus("ok", "Pronto", "mapa interno selecionado");
      }else{
        setUploadsStatus("ok", "Pronto", state.hasUserBase ? "arquivo selecionado — clique em Analisar dados" : "carregue uma base ou veja a demo");
      }
      syncActionButtons();
    });

    /********************
     * Templates
     ********************/
    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    $("#tplBaseBtn").addEventListener("click", () => {
      const header = [
        "Cidade",
        "Estado",
        "Data de criação",
        "Vendas",
        "Perdidos",
        "Em andamento",
        "Pausados",
        "ID (opcional)",
        "Nome (opcional)"
      ];
      const sample = [
        "Juiz de Fora",
        "MG",
        "2025-10-15",
        "1",
        "0",
        "0",
        "0",
        "123",
        "Exemplo"
      ];
      downloadText("template_base_crm.csv", header.join(",") + "\n" + sample.join(",") + "\n");
    });

    $("#tplMapBtn").addEventListener("click", () => {
      const header = [
        "cidade",
        "uf",
        "microrregiao",
        "regiao (opcional)"
      ];
      const sample = [
        "Juiz de Fora",
        "MG",
        "Zona da Mata",
        "Sudeste"
      ];
      downloadText("template_mapa_interno.csv", header.join(",") + "\n" + sample.join(",") + "\n");
    });

    /********************
     * State + parsing
     ********************/
    const state = {
      hasUserBase: false,
      raw: [],
      enriched: [],
      mapInternal: null,
      analyzed: false,

      filters: {
        month: "__all",
        region: "__all",
        uf: "__all",
        rateBase: "closed",
      },

      charts: {
        region: null,
        winRateRegion: null,
        uf: null,
        monthly: null,
      },

      table: null,
      tableAllRows: [],
      rowsLimit: 25,
    };

    const analyzeBtn = $("#analyzeBtn");
    const clearAllBtn = $("#clearAllBtn");

    function syncActionButtons(){
      analyzeBtn.textContent = state.hasUserBase ? "Analisar dados" : "Ver demo";

      // Limpar aparece só se houver algo a limpar (pedido)
      const hasMap = !!mapFileInput.files?.[0];
      const hasBase = !!baseFileInput.files?.[0];
      const hasAnalysis = state.analyzed;
      const hasFilters = (
        state.filters.month !== "__all" ||
        state.filters.region !== "__all" ||
        state.filters.uf !== "__all" ||
        state.filters.rateBase !== "closed"
      );
      clearAllBtn.classList.toggle("hidden", !(hasMap || hasBase || hasAnalysis || hasFilters));
    }
    syncActionButtons();

    clearAllBtn.addEventListener("click", () => {
      // reset inputs
      baseFileInput.value = "";
      mapFileInput.value = "";
      baseFileName.textContent = "Nenhum arquivo selecionado";
      mapFileName.textContent  = "Nenhum arquivo selecionado";

      state.hasUserBase = false;
      state.raw = [];
      state.enriched = [];
      state.mapInternal = null;
      state.analyzed = false;

      // reset filters
      state.filters = { month:"__all", region:"__all", uf:"__all", rateBase:"closed" };
      $("#rateBaseFilter").value = "closed";

      setUploadsStatus("ok", "Pronto", "carregue uma base ou veja a demo");
      syncActionButtons();

      // clear UI
      fillSelect($("#monthFilter"), [{value:"__all", label:"Todos os meses"}], "Todos os meses");
      fillSelect($("#regionFilter"), [{value:"__all", label:"Todas as regiões"}], "Todas as regiões");
      fillSelect($("#ufFilter"), [{value:"__all", label:"Todos os estados"}], "Todos os estados");

      renderKPIs(null);
      renderTriGrid([], [], []);
      destroyCharts();
      updateChartRegionClearUI(false);

      if(state.table){
        state.table.clearData();
      }
      state.tableAllRows = [];
    });

    /********************
     * Helpers: normalize + date
     ********************/
    function stripAccents(s){
      return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    }
    function normKey(s){
      return stripAccents(String(s||""))
        .toLowerCase()
        .trim()
        .replace(/\s+/g," ")
        .replace(/[^\w ]/g,"")
        .replace(/\s/g,"");
    }
    function getVal(row, keys){
      for(const k of keys){
        const kk = normKey(k);
        if(kk in row && row[kk] !== undefined && row[kk] !== null && String(row[kk]).trim() !== "") return row[kk];
      }
      return "";
    }
    function toNum(v){
      if(v === null || v === undefined) return 0;
      const s = String(v).trim().replace(",",".");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function parseDate(raw){
      const s = String(raw||"").trim();
      if(!s) return null;

      // ISO-like
      const d1 = new Date(s);
      if(!isNaN(d1.getTime())) return d1;

      // dd/mm/yyyy
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
      if(m){
        const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
        const d = new Date(yy, mm-1, dd);
        if(!isNaN(d.getTime())) return d;
      }
      return null;
    }
    function monthKey(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }
    function formatMonthLabel(key){
      // key YYYY-MM -> mmm/AA
      const [yy, mm] = key.split("-").map(Number);
      const months = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"];
      return `${months[(mm||1)-1]}/${String(yy).slice(2)}`;
    }
    const REGION_BY_UF = {
      "AC":"Norte","AL":"Nordeste","AP":"Norte","AM":"Norte","BA":"Nordeste","CE":"Nordeste","DF":"Centro-Oeste","ES":"Sudeste","GO":"Centro-Oeste","MA":"Nordeste","MT":"Centro-Oeste","MS":"Centro-Oeste","MG":"Sudeste","PA":"Norte","PB":"Nordeste","PR":"Sul","PE":"Nordeste","PI":"Nordeste","RJ":"Sudeste","RN":"Nordeste","RS":"Sul","RO":"Norte","RR":"Norte","SC":"Sul","SP":"Sudeste","SE":"Nordeste","TO":"Norte"
    };
    const REGION_UFS = Object.entries(REGION_BY_UF).reduce((acc,[uf,reg])=>{
      acc[reg] = acc[reg] || [];
      acc[reg].push(uf);
      return acc;
    }, {});

    /********************
     * File parsing (CSV/XLSX)
     ********************/
    async function readFileAsRows(file){
      const ext = (file.name.split(".").pop() || "").toLowerCase();
      if(ext === "xlsx" || ext === "xls"){
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, {type:"array"});
        const wsName = wb.SheetNames[0];
        const ws = wb.Sheets[wsName];
        const json = XLSX.utils.sheet_to_json(ws, {defval:""});
        return normalizeRows(json);
      }else{
        const text = await file.text();
        return new Promise((resolve, reject) => {
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: (res) => resolve(normalizeRows(res.data)),
            error: (err) => reject(err)
          });
        });
      }
    }

    function normalizeRows(rows){
      // transforma chaves do objeto em normKey
      return rows.map(r=>{
        const out = {};
        Object.keys(r || {}).forEach(k=>{
          out[normKey(k)] = r[k];
        });
        return out;
      });
    }

    /********************
     * Internal map parsing
     ********************/
    async function parseInternalMapIfAny(){
      const f = mapFileInput.files?.[0];
      if(!f) return null;
      const rows = await readFileAsRows(f);
      const map = new Map();
      for(const r of rows){
        const cidade = String(getVal(r, ["cidade","municipio","município"])).trim();
        const uf = String(getVal(r, ["uf","estado"])).trim().toUpperCase();
        const micro = String(getVal(r, ["microrregiao","microrregião","microregiao"])).trim();
        const regiao = String(getVal(r, ["regiao","região"])).trim();
        if(!cidade || !uf || !micro) continue;
        const key = `${stripAccents(cidade).toLowerCase()}|${uf}`;
        map.set(key, {micro, regiao});
      }
      return map;
    }

    /********************
     * Enrichment
     ********************/
    function enrichBaseRows(rows, mapInternal){
      const enriched = [];
      for(const r of rows){
        const cidade = String(getVal(r, ["cidade","municipio","município"])).trim();
        const uf = String(getVal(r, ["estado","uf"])).trim().toUpperCase();
        const micro = String(getVal(r, ["microrregiao","microrregião","microregiao","microregiaoibge"])).trim();
        const regiao = String(getVal(r, ["regiao","região"])).trim();

        const dRaw = getVal(r, ["datadecriacao","data de criacao","criacao","data"]);
        const d = parseDate(dRaw);
        const mk = d ? monthKey(d) : "";

        // status columns
        const vendas = toNum(getVal(r, ["vendas","ganhas","wins"]));
        const perdidos = toNum(getVal(r, ["perdidos","perdas","lost"]));
        const andamento = toNum(getVal(r, ["emandamento","em andamento","emnegociacao","em negociacao","ativas","abertas"]));
        const pausados = toNum(getVal(r, ["pausados","pausado"]));

        // fallback: se vier “status” textual
        let v = vendas, p = perdidos, a = andamento, z = pausados;
        const statusTxt = String(getVal(r, ["status","etapa"])).toLowerCase().trim();
        if(statusTxt && (v+p+a+z) === 0){
          if(statusTxt.includes("vend") || statusTxt.includes("ganh")) v = 1;
          else if(statusTxt.includes("perd")) p = 1;
          else if(statusTxt.includes("paus")) z = 1;
          else a = 1;
        }

        const base = {
          cidade,
          uf,
          month: mk,
          vendas: v,
          perdidos: p,
          andamento: a,
          pausados: z,
        };

        if(!cidade || !uf) continue;

        // Region fallback by UF
        let reg = regiao || REGION_BY_UF[uf] || "";
        let mic = micro;

        // If micro missing, try map internal
        if(!mic && mapInternal){
          const key = `${stripAccents(cidade).toLowerCase()}|${uf}`;
          const hit = mapInternal.get(key);
          if(hit){
            mic = hit.micro || mic;
            reg = hit.regiao || reg;
          }
        }

        enriched.push({
          ...base,
          regiao: reg || "—",
          microrregiao: mic || "—",
        });
      }
      return enriched;
    }

    /********************
     * Aggregation
     ********************/
    function aggKey(parts){ return parts.join("||"); }

    function aggregate(enriched){
      const f = state.filters;

      const filtered = enriched.filter(r=>{
        if(f.month !== "__all" && r.month !== f.month) return false;
        if(f.region !== "__all" && r.regiao !== f.region) return false;
        if(f.uf !== "__all" && r.uf !== f.uf) return false;
        return true;
      });

      // totals
      let totalV=0,totalP=0,totalA=0,totalZ=0;
      for(const r of filtered){
        totalV += r.vendas;
        totalP += r.perdidos;
        totalA += r.andamento;
        totalZ += r.pausados;
      }
      const total = totalV + totalP + totalA + totalZ;

      // months list
      const months = Array.from(new Set(enriched.map(r=>r.month).filter(Boolean))).sort();

      // groups
      const byRegion = new Map();
      const byUF = new Map();
      const byCity = new Map();

      function add(map, key, obj){
        if(!map.has(key)){
          map.set(key, { ...obj, vendas:0, perdidos:0, andamento:0, pausados:0, total:0 });
        }
        const it = map.get(key);
        it.vendas += obj.vendas;
        it.perdidos += obj.perdidos;
        it.andamento += obj.andamento;
        it.pausados += obj.pausados;
        it.total += (obj.vendas + obj.perdidos + obj.andamento + obj.pausados);
      }

      for(const r of filtered){
        add(byRegion, r.regiao, r);
        add(byUF, r.uf, r);

        const k = aggKey([r.regiao, r.uf, r.microrregiao, r.cidade]);
        if(!byCity.has(k)){
          byCity.set(k, { regiao:r.regiao, uf:r.uf, microrregiao:r.microrregiao, cidade:r.cidade, vendas:0, perdidos:0, andamento:0, pausados:0, total:0 });
        }
        const c = byCity.get(k);
        c.vendas += r.vendas;
        c.perdidos += r.perdidos;
        c.andamento += r.andamento;
        c.pausados += r.pausados;
        c.total += (r.vendas+r.perdidos+r.andamento+r.pausados);
      }

      const regions = Array.from(new Set(enriched.map(r=>r.regiao).filter(Boolean))).sort();
      const ufs = Array.from(new Set(enriched.map(r=>r.uf).filter(Boolean))).sort();

      return {
        filtered,
        totals: { total, vendas: totalV, perdidos: totalP, andamento: totalA, pausados: totalZ },
        months,
        regions,
        ufs,
        byRegion,
        byUF,
        byCity
      };
    }

    function rateBaseDenominator(obj){
      const base = state.filters.rateBase;
      if(base === "total") return (obj.vendas + obj.perdidos + obj.andamento); // pausados fora
      return (obj.vendas + obj.perdidos);
    }

    function pct(x){
      if(!isFinite(x)) return "0,0%";
      return (x*100).toFixed(1).replace(".",",") + "%";
    }

    /********************
     * Filters UI
     ********************/
    const monthFilter = $("#monthFilter");
    const regionFilter = $("#regionFilter");
    const ufFilter = $("#ufFilter");
    const rateBaseFilter = $("#rateBaseFilter");

    function fillSelect(selectEl, options, placeholderLabel){
      const v = selectEl.value;
      selectEl.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "__all";
      ph.textContent = placeholderLabel;
      selectEl.appendChild(ph);
      for(const opt of options){
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.label;
        selectEl.appendChild(o);
      }
      // restore if possible
      if(Array.from(selectEl.options).some(o=>o.value===v)) selectEl.value = v;
      else selectEl.value = "__all";
    }

    function rebuildUFOptionsByRegion(regionValue, allUFs){
      if(regionValue === "__all"){
        fillSelect(ufFilter, allUFs.map(u=>({value:u,label:u})), "Todos os estados");
        return;
      }
      const allowed = (REGION_UFS[regionValue] || []).slice().sort();
      const existing = allowed.filter(u=>allUFs.includes(u));
      fillSelect(ufFilter, existing.map(u=>({value:u,label:u})), "Todos os estados");
    }

    monthFilter.addEventListener("change", () => {
      state.filters.month = monthFilter.value;
      rerender();
      syncActionButtons();
    });

    regionFilter.addEventListener("change", () => {
      state.filters.region = regionFilter.value;

      // item 4 anterior: ao mudar região, limpar estado e limitar estados
      state.filters.uf = "__all";
      const allUFs = Array.from(new Set(state.enriched.map(r=>r.uf).filter(Boolean))).sort();
      rebuildUFOptionsByRegion(regionFilter.value, allUFs);
      ufFilter.value = "__all";

      rerender();
      syncActionButtons();
    });

    ufFilter.addEventListener("change", () => {
      state.filters.uf = ufFilter.value;
      rerender();
      syncActionButtons();
    });

    rateBaseFilter.addEventListener("change", () => {
      state.filters.rateBase = rateBaseFilter.value;
      rerender();
      syncActionButtons();
    });

    $("#clearFiltersBtn").addEventListener("click", () => {
      state.filters.month = "__all";
      state.filters.region = "__all";
      state.filters.uf = "__all";
      state.filters.rateBase = "closed";

      monthFilter.value = "__all";
      regionFilter.value = "__all";
      rateBaseFilter.value = "closed";

      const allUFs = Array.from(new Set(state.enriched.map(r=>r.uf).filter(Boolean))).sort();
      rebuildUFOptionsByRegion("__all", allUFs);
      ufFilter.value = "__all";

      updateChartRegionClearUI(false);
      rerender();
      syncActionButtons();
    });

    /********************
     * KPI render
     ********************/
    const kpiGrid = $("#kpiGrid");

    function renderKPIs(agg){
      kpiGrid.innerHTML = "";
      if(!agg){
        return;
      }
      const t = agg.totals;
      const baseDen = rateBaseDenominator(t);
      const winRate = baseDen ? (t.vendas / baseDen) : 0;
      const lossRate = baseDen ? (t.perdidos / baseDen) : 0;

      const kpis = [
        { title:"Registros", value: t.total, sub:"após filtros" },
        { title:"Ganhas", value: t.vendas, rate: pct(winRate), rateClass:"win", sub:"quantidade | taxa" },
        { title:"Perdidas", value: t.perdidos, rate: pct(lossRate), rateClass:"loss", sub:"quantidade | taxa" },
        { title:"Em negociação", value: t.andamento, sub:"ativas" },
      ];

      for(const k of kpis){
        const el = document.createElement("div");
        el.className = "kpi";
        const valueHtml = (k.rate)
          ? `<div class="vRow">
               <div class="vMain" style="color:${k.title==='Ganhas' ? 'var(--kpiWin)' : 'var(--kpiLoss)'}">${fmtInt(k.value)}</div>
               <div class="vRate ${k.rateClass}">| ${k.rate}</div>
             </div>`
          : `<div class="v">${fmtInt(k.value)}</div>`;
        el.innerHTML = `
          <div class="t">${k.title}</div>
          ${valueHtml}
          <div class="s">${k.sub}</div>
        `;
        kpiGrid.appendChild(el);
      }
    }

    function fmtInt(n){
      const v = Math.round(n || 0);
      return v.toLocaleString("pt-BR");
    }

    /********************
     * TriGrid render (Opp / Risks / Auto)
     ********************/
    const triGrid = $("#triGrid");

    function renderTriGrid(opps, risks, autos){
      triGrid.innerHTML = "";
      const max = Math.max(opps.length, risks.length, autos.length);
      for(let i=0; i<max; i++){
        const a = opps[i] || null;
        const b = risks[i] || null;
        const c = autos[i] || null;

        triGrid.appendChild(a ? a : emptyCard("Oportunidades"));
        triGrid.appendChild(b ? b : emptyCard("Riscos"));
        triGrid.appendChild(c ? c : emptyCard("Insights"));
      }
      wireStatFlip();
    }

    function emptyCard(title){
      const el = document.createElement("div");
      el.className = "miniCard";
      el.innerHTML = `
        <div class="miniTop">
          <div>
            <h3 class="miniTitle">${title}</h3>
            <div class="miniSub">—</div>
          </div>
          <span class="pill pillAuto">auto</span>
        </div>
        <div class="statsGrid">
          ${[0,1,2,3].map(()=>statBox("—","—","Sem dados para este recorte.")).join("")}
        </div>
      `;
      return el;
    }

    function statBox(label, value, tip){
      return `
        <div class="statBox" data-tip="${escapeHtml(tip)}">
          <span class="infoDot">i</span>
          <div class="statInner">
            <div class="statFront">
              <div class="statLabel">${escapeHtml(label)}</div>
              <div class="statValue">${escapeHtml(value)}</div>
            </div>
            <div class="statBack">
              <div class="statLabel">${escapeHtml(label)}</div>
              <p>${escapeHtml(tip)}</p>
              <p style="opacity:.9"><b>Dica:</b> clique fora para voltar.</p>
            </div>
          </div>
        </div>
      `;
    }

    function escapeHtml(s){
      return String(s||"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function makeCityCard(kind, row){
      const den = rateBaseDenominator(row);
      const wr = den ? row.vendas/den : 0;
      const lr = den ? row.perdidos/den : 0;
      const badge = kind === "opp"
        ? `<span class="badgeRate badgeWin">Ganho ${pct(wr)}</span>`
        : `<span class="badgeRate badgeLoss">Perda ${pct(lr)}</span>`;

      const title = escapeHtml(row.cidade);
      const sub = `${escapeHtml(row.regiao)} · ${escapeHtml(row.uf)} · ${escapeHtml(row.microrregiao)}`;

      const el = document.createElement("div");
      el.className = "miniCard";
      el.innerHTML = `
        <div class="miniTop">
          <div style="min-width:0">
            <h3 class="miniTitle">${title}</h3>
            <div class="miniSub">${sub}</div>
          </div>
          ${badge}
        </div>
        <div class="statsGrid">
          ${statBox("Volume", fmtInt(row.total), "Total de registros neste recorte. Use volume para validar se a taxa é confiável.")}
          ${statBox("Ganhas", fmtInt(row.vendas), "Vendas confirmadas. Compare taxa e volume com sua média para priorizar replicação.")}
          ${statBox("Em negociação", fmtInt(row.andamento), "Oportunidades abertas. Se alto, pode indicar funil travado ou ciclo mais longo.")}
          ${statBox("Perdidas", fmtInt(row.perdidos), "Perdas no recorte. Investigue causa raiz (qualificação, oferta, timing) e ajuste o funil.")}
        </div>
      `;
      return el;
    }

    function makeAutoCard(title, subtitle, metrics){
      const el = document.createElement("div");
      el.className = "miniCard";
      el.innerHTML = `
        <div class="miniTop">
          <div style="min-width:0">
            <h3 class="miniTitle">${escapeHtml(title)}</h3>
            <div class="miniSub">${escapeHtml(subtitle)}</div>
          </div>
          <span class="pill pillAuto">auto</span>
        </div>
        <div class="statsGrid">
          ${metrics.map(m=>statBox(m.label, m.value, m.tip)).join("")}
        </div>
      `;
      return el;
    }

    function wireStatFlip(){
      // delegação: ao clicar num statBox, expande e “vira”
      triGrid.querySelectorAll(".miniCard").forEach(card=>{
        card.addEventListener("click", (ev) => {
          const box = ev.target.closest(".statBox");
          if(!box) return;

          // se já está expandido e clicou no próprio, fecha
          const isExpanded = card.classList.contains("expanded");
          const isActive = box.classList.contains("active");

          // reset
          card.classList.remove("expanded");
          card.querySelectorAll(".statBox").forEach(b=>b.classList.remove("active"));

          if(!(isExpanded && isActive)){
            card.classList.add("expanded");
            box.classList.add("active");
          }
        });

        // clicar fora do card fecha
        document.addEventListener("click", (e) => {
          if(!card.contains(e.target)){
            card.classList.remove("expanded");
            card.querySelectorAll(".statBox").forEach(b=>b.classList.remove("active"));
          }
        }, {capture:true});
      });
    }

    /********************
     * Charts: external tooltip + hover glow
     ********************/
    const tooltipEl = $("#chartTooltip");
    const tooltipHideTimers = new WeakMap();

    function cssVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function tooltipHTML(title, items){
      const rows = items.map(it=>{
        return `
          <div class="ct-row">
            <span class="ct-swatch" style="background:${it.color}"></span>
            <span>${escapeHtml(it.label)}: <b>${escapeHtml(it.value)}</b></span>
          </div>
        `;
      }).join("");
      return `<div class="ct-title">${escapeHtml(title)}</div>${rows}`;
    }

    function showTooltipAt(x, y, html){
      tooltipEl.innerHTML = html;
      tooltipEl.style.left = x + "px";
      tooltipEl.style.top = y + "px";
      tooltipEl.style.opacity = "1";
    }

    function scheduleHideTooltip(){
      const old = tooltipHideTimers.get(tooltipEl);
      if(old) clearTimeout(old);
      const t = setTimeout(()=>{ tooltipEl.style.opacity = "0"; }, 120);
      tooltipHideTimers.set(tooltipEl, t);
    }

    function externalTooltipHandler(ctx){
      const { chart, tooltip } = ctx;
      const canvasRect = chart.canvas.getBoundingClientRect();

      if(tooltip.opacity === 0){
        // não some instantâneo -> dá sensação de “arraste”
        scheduleHideTooltip();
        return;
      }
      const old = tooltipHideTimers.get(tooltipEl);
      if(old) clearTimeout(old);

      const title = (tooltip.title && tooltip.title[0]) ? tooltip.title[0] : "";
      const bodyLines = tooltip.dataPoints || [];

      const items = bodyLines.map(dp=>{
        const ds = chart.data.datasets[dp.datasetIndex];
        const label = ds.label || "";
        let value = dp.formattedValue;

        // Se for taxa (0-1), converter p/ %
        if(typeof dp.raw === "number" && dp.raw <= 1 && dp.raw >= 0 && label.toLowerCase().includes("taxa")){
          value = pct(dp.raw);
        }

        return {
          label,
          value,
          color: ds.borderColor || ds.backgroundColor || "rgba(255,255,255,.4)"
        };
      });

      const x = canvasRect.left + tooltip.caretX;
      const y = canvasRect.top  + tooltip.caretY;

      showTooltipAt(x, y, tooltipHTML(title, items));
    }

    const hoverGlowPlugin = {
      id: "hoverGlow",
      beforeDatasetsDraw(chart){
        const act = chart.getActiveElements?.() || [];
        if(!act.length) return;
        const ctx = chart.ctx;
        ctx.save();
        ctx.shadowBlur = 18;
        ctx.shadowColor = "rgba(0,0,0,.20)";
        ctx.shadowOffsetY = 6;

        // desenha uma “borda” discreta no elemento ativo (sensação de hover)
        act.forEach(a=>{
          const meta = chart.getDatasetMeta(a.datasetIndex);
          const el = meta.data[a.index];
          if(!el) return;
          const props = el.getProps(["x","y","base","width","height"], true);
          if(props.width){
            const w = props.width + 6;
            const x = props.x - w/2;
            const y = Math.min(props.y, props.base) - 3;
            const h = Math.abs(props.base - props.y) + 6;
            ctx.strokeStyle = "rgba(255,255,255,.10)";
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, w, h);
          }
        });
        ctx.restore();
      }
    };

    function chartCommonOptions(){
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: { enabled: false, external: externalTooltipHandler },
          legend: {
            labels: {
              color: cssVar("--axis"),
              font: { family: cssVar("--font"), size: 14, weight: "700" }
            }
          }
        },
        hover: {
          onHover: (evt, activeEls) => {
            evt.native.target.style.cursor = activeEls?.length ? "pointer" : "default";
          }
        }
      };
    }

    function applyThemeToCharts(){
      // aplica fonte SF no Chart.js
      if(window.Chart){
        Chart.defaults.font.family = cssVar("--font");
      }
      // atualiza cores nos charts existentes (pedido do print 4)
      const tickColor = cssVar("--axis");
      const gridColor = cssVar("--grid");

      Object.values(state.charts).forEach(ch=>{
        if(!ch) return;
        if(ch.options?.scales){
          for(const axis of Object.values(ch.options.scales)){
            if(axis.ticks) axis.ticks.color = tickColor;
            if(axis.grid) axis.grid.color = gridColor;
            if(axis.border) axis.border.color = gridColor;
          }
        }
        if(ch.options?.plugins?.legend?.labels){
          ch.options.plugins.legend.labels.color = tickColor;
        }
        ch.update();
      });
    }

    function destroyCharts(){
      Object.keys(state.charts).forEach(k=>{
        if(state.charts[k]){
          state.charts[k].destroy();
          state.charts[k] = null;
        }
      });
    }

    function updateChartRegionClearUI(active){
      $("#chartRegionClearWrap").style.display = active ? "block" : "none";
    }
    $("#chartRegionClear").addEventListener("click", (e)=>{
      e.preventDefault();
      state.filters.region = "__all";
      regionFilter.value = "__all";

      const allUFs = Array.from(new Set(state.enriched.map(r=>r.uf).filter(Boolean))).sort();
      rebuildUFOptionsByRegion("__all", allUFs);
      ufFilter.value = "__all";
      state.filters.uf = "__all";

      updateChartRegionClearUI(false);
      rerender();
    });

    /********************
     * Table (no pagination + expands)
     ********************/
    function ensureTable(){
      if(state.table) return;

      state.table = new Tabulator("#citiesTable", {
        layout: "fitColumns",
        reactiveData: false,
        data: [],
        height: false,           // sem altura fixa (expande)
        selectable: false,
        columnDefaults: {
          headerFilter: "input",
          headerFilterPlaceholder: "filtrar…",
          headerSortTristate: true,
          resizable: true,
        },
        columns: [
          { title: "Região", field: "regiao", width: 120 },
          { title: "Estado", field: "uf", width: 90 },
          { title: "Microrregião", field: "microrregiao", minWidth: 160 },
          { title: "Cidade", field: "cidade", minWidth: 170 },
          { title: "Total", field: "total", hozAlign: "right", sorter:"number", width: 110 },
          { title: "Ganhas", field: "vendas", hozAlign: "right", sorter:"number", width: 110 },
          { title: "Perdidas", field: "perdidos", hozAlign: "right", sorter:"number", width: 110 },
          { title: "Em negociação", field: "andamento", hozAlign: "right", sorter:"number", width: 140 },
          { title: "Tx ganho", field: "txGanho", hozAlign: "right", width: 110 },
          { title: "Tx perda", field: "txPerda", hozAlign: "right", width: 110 },
        ],
      });
    }

    function applyThemeToTable(){
      // Tabulator já herda via CSS; aqui só garantimos fonte
      const el = $("#citiesTable");
      if(el) el.style.fontFamily = cssVar("--font");
    }

    $("#rowsSelect").addEventListener("change", ()=>{
      state.rowsLimit = Number($("#rowsSelect").value) || 25;
      renderTableFromState();
      syncActionButtons();
    });

    $("#tableSearch").addEventListener("input", ()=>{
      if(!state.table) return;
      const q = $("#tableSearch").value.trim().toLowerCase();
      if(!q){
        renderTableFromState();
        return;
      }
      const filtered = state.tableAllRows.filter(r=>{
        const s = `${r.regiao} ${r.uf} ${r.microrregiao} ${r.cidade}`.toLowerCase();
        return s.includes(q);
      });
      state.table.replaceData(filtered.slice(0, state.rowsLimit));
    });

    function renderTableFromState(){
      ensureTable();
      const rows = state.tableAllRows.slice(0, state.rowsLimit);
      state.table.replaceData(rows);
    }

    /********************
     * Downloads (resumo / cidades)
     ********************/
    $("#downloadSummaryBtn").addEventListener("click", ()=>{
      if(!state.analyzed) return;
      const agg = aggregate(state.enriched);
      const t = agg.totals;
      const den = rateBaseDenominator(t);
      const wr = den ? t.vendas/den : 0;
      const lr = den ? t.perdidos/den : 0;

      const header = ["Registros","Ganhas","Perdidas","Em negociação","Tx ganho","Tx perda"];
      const row = [t.total, t.vendas, t.perdidos, t.andamento, pct(wr), pct(lr)];
      downloadText("resumo.csv", header.join(",")+"\n"+row.join(",")+"\n");
    });

    $("#downloadCitiesBtn").addEventListener("click", ()=>{
      if(!state.analyzed) return;
      const header = ["Região","Estado","Microrregião","Cidade","Total","Ganhas","Perdidas","Em negociação","Tx ganho","Tx perda"];
      const lines = [header.join(",")].concat(
        state.tableAllRows.map(r=>[
          r.regiao, r.uf, r.microrregiao, r.cidade,
          r.total, r.vendas, r.perdidos, r.andamento,
          r.txGanho, r.txPerda
        ].map(x=>String(x).includes(",") ? `"${String(x).replace(/"/g,'""')}"` : x).join(","))
      );
      downloadText("cidades.csv", lines.join("\n")+"\n");
    });

    /********************
     * Charts render
     ********************/
    function createOrUpdateCharts(agg){
      const tickColor = cssVar("--axis");
      const gridColor = cssVar("--grid");

      // Volume por Região (stacked)
      const regLabels = Array.from(agg.byRegion.keys()).sort((a,b)=> (agg.byRegion.get(b).total - agg.byRegion.get(a).total));
      const regV = regLabels.map(r=>agg.byRegion.get(r).vendas);
      const regP = regLabels.map(r=>agg.byRegion.get(r).perdidos);
      const regA = regLabels.map(r=>agg.byRegion.get(r).andamento);

      const regionCtx = $("#chartRegion").getContext("2d");
      if(state.charts.region) state.charts.region.destroy();
      state.charts.region = new Chart(regionCtx, {
        type: "bar",
        data: {
          labels: regLabels,
          datasets: [
            { label:"Ganhas", data: regV, backgroundColor: cssVar("--blue"), borderColor: cssVar("--blueLine"), borderWidth: 0 },
            { label:"Perdidas", data: regP, backgroundColor: cssVar("--pink"), borderColor: cssVar("--pinkLine"), borderWidth: 0 },
            { label:"Em negociação", data: regA, backgroundColor: cssVar("--amber"), borderColor: cssVar("--amberLine"), borderWidth: 0 },
          ]
        },
        options: {
          ...chartCommonOptions(),
          scales: {
            x: { stacked:true, ticks:{ color: tickColor, font:{family:cssVar("--font"), weight:"700"} }, grid:{ color: gridColor }, border:{ color: gridColor } },
            y: { stacked:true, ticks:{ color: tickColor, font:{family:cssVar("--font"), weight:"700"} }, grid:{ color: gridColor }, border:{ color: gridColor } }
          },
          onClick: (evt) => {
            const points = state.charts.region.getElementsAtEventForMode(evt, "nearest", {intersect:true}, true);
            if(!points.length) return;
            const idx = points[0].index;
            const label = regLabels[idx];
            state.filters.region = label;
            regionFilter.value = label;

            // limitar estados
            const allUFs = Array.from(new Set(state.enriched.map(r=>r.uf).filter(Boolean))).sort();
            rebuildUFOptionsByRegion(label, allUFs);
            ufFilter.value = "__all";
            state.filters.uf = "__all";

            updateChartRegionClearUI(true);
            rerender();
          }
        },
        plugins:[hoverGlowPlugin]
      });

      // Taxa de ganho por Região
      const wrLabels = regLabels.slice();
      const wrData = wrLabels.map(r=>{
        const o = agg.byRegion.get(r);
        const den = rateBaseDenominator(o);
        return den ? (o.vendas/den) : 0;
      });

      const wrCtx = $("#chartWinRateRegion").getContext("2d");
      if(state.charts.winRateRegion) state.charts.winRateRegion.destroy();
      state.charts.winRateRegion = new Chart(wrCtx, {
        type: "bar",
        data: {
          labels: wrLabels,
          datasets: [
            { label:"Taxa de ganho", data: wrData, backgroundColor: cssVar("--blue"), borderColor: cssVar("--blueLine"), borderWidth: 0 }
          ]
        },
        options: {
          ...chartCommonOptions(),
          plugins: {
            ...chartCommonOptions().plugins,
            tooltip: { enabled:false, external: externalTooltipHandler }
          },
          scales: {
            x: { ticks:{ color: tickColor, font:{family:cssVar("--font"), weight:"700"} }, grid:{ color: gridColor }, border:{ color: gridColor } },
            y: {
              suggestedMin: 0,
              suggestedMax: 1,
              ticks:{
                color: tickColor,
                font:{family:cssVar("--font"), weight:"700"},
                callback: (v)=> (Number(v)*100).toFixed(0)+"%"
              },
              grid:{ color: gridColor },
              border:{ color: gridColor }
            }
          }
        },
        plugins:[hoverGlowPlugin]
      });

      // Volume por Estado (stacked)
      const ufLabels = Array.from(agg.byUF.keys()).sort((a,b)=> (agg.byUF.get(b).total - agg.byUF.get(a).total));
      const ufV = ufLabels.map(u=>agg.byUF.get(u).vendas);
      const ufP = ufLabels.map(u=>agg.byUF.get(u).perdidos);
      const ufA = ufLabels.map(u=>agg.byUF.get(u).andamento);

      const ufCtx = $("#chartUF").getContext("2d");
      if(state.charts.uf) state.charts.uf.destroy();
      state.charts.uf = new Chart(ufCtx, {
        type:"bar",
        data:{
          labels: ufLabels,
          datasets:[
            { label:"Ganhas", data: ufV, backgroundColor: cssVar("--blue"), borderColor: cssVar("--blueLine"), borderWidth: 0 },
            { label:"Perdidas", data: ufP, backgroundColor: cssVar("--pink"), borderColor: cssVar("--pinkLine"), borderWidth: 0 },
            { label:"Em negociação", data: ufA, backgroundColor: cssVar("--amber"), borderColor: cssVar("--amberLine"), borderWidth: 0 },
          ]
        },
        options:{
          ...chartCommonOptions(),
          scales:{
            x:{ stacked:true, ticks:{ color: tickColor, font:{family:cssVar("--font"), weight:"700"} }, grid:{ color: gridColor }, border:{ color: gridColor } },
            y:{ stacked:true, ticks:{ color: tickColor, font:{family:cssVar("--font"), weight:"700"} }, grid:{ color: gridColor }, border:{ color: gridColor } }
          }
        },
        plugins:[hoverGlowPlugin]
      });

      // Evolução mensal (Ganhas x Perdidos)
      const mKeys = agg.months;
      const mAgg = new Map();
      for(const k of mKeys){
        mAgg.set(k, {v:0,p:0});
      }
      for(const r of agg.filtered){
        if(!r.month) continue;
        const it = mAgg.get(r.month) || {v:0,p:0};
        it.v += r.vendas;
        it.p += r.perdidos;
        mAgg.set(r.month, it);
      }
      const mLabels = mKeys.map(formatMonthLabel);
      const mV = mKeys.map(k=>mAgg.get(k)?.v || 0);
      const mP = mKeys.map(k=>mAgg.get(k)?.p || 0);

      const mCtx = $("#chartMonthly").getContext("2d");
      if(state.charts.monthly) state.charts.monthly.destroy();
      state.charts.monthly = new Chart(mCtx, {
        type:"line",
        data:{
          labels: mLabels,
          datasets:[
            { label:"Ganhas", data: mV, borderColor: cssVar("--blueLine"), backgroundColor: "transparent", pointRadius: 4, pointHoverRadius: 6, borderWidth: 3, tension: .25 },
            { label:"Perdidas", data: mP, borderColor: cssVar("--pinkLine"), backgroundColor: "transparent", pointRadius: 4, pointHoverRadius: 6, borderWidth: 3, tension: .25 },
          ]
        },
        options:{
          ...chartCommonOptions(),
          scales:{
            x:{ ticks:{ color: tickColor, font:{family:cssVar("--font"), weight:"700"} }, grid:{ color: gridColor }, border:{ color: gridColor } },
            y:{ ticks:{ color: tickColor, font:{family:cssVar("--font"), weight:"700"} }, grid:{ color: gridColor }, border:{ color: gridColor } }
          }
        }
      });

      applyThemeToCharts();
    }

    /********************
     * Rerender pipeline
     ********************/
    function rerender(){
      if(!state.analyzed) return;

      const agg = aggregate(state.enriched);

      renderKPIs(agg);
      renderInsights(agg);
      createOrUpdateCharts(agg);
      buildTableRows(agg);

      syncActionButtons();
    }

    function renderInsights(agg){
      // Opps/Risks: top cidades
      const cities = Array.from(agg.byCity.values());
      cities.forEach(c=>{
        const den = rateBaseDenominator(c);
        c._wr = den ? c.vendas/den : 0;
        c._lr = den ? c.perdidos/den : 0;
      });

      const oppTop = cities
        .filter(c=>c.total >= 5)
        .sort((a,b)=> (b._wr - a._wr) || (b.total - a.total))
        .slice(0,3)
        .map(c=>makeCityCard("opp", c));

      const riskTop = cities
        .filter(c=>c.total >= 5)
        .sort((a,b)=> (b._lr - a._lr) || (b.total - a.total))
        .slice(0,3)
        .map(c=>makeCityCard("risk", c));

      // Auto insights: “pra onde eu olho” (dinâmico)
      // - sem filtro região: olha Regiões
      // - com Região e sem Estado: olha Estados
      // - com Estado: olha Microrregiões
      let level = "regiao";
      if(state.filters.region !== "__all" && state.filters.uf === "__all") level = "uf";
      if(state.filters.uf !== "__all") level = "microrregiao";

      function buildGroup(){
        const map = new Map();
        function add(key, r){
          if(!map.has(key)) map.set(key, {key, vendas:0, perdidos:0, andamento:0, total:0});
          const it = map.get(key);
          it.vendas += r.vendas;
          it.perdidos += r.perdidos;
          it.andamento += r.andamento;
          it.total += (r.vendas+r.perdidos+r.andamento+r.pausados);
        }
        for(const r of agg.filtered){
          let k = r.regiao;
          if(level === "uf") k = r.uf;
          if(level === "microrregiao") k = r.microrregiao;
          add(k, r);
        }
        return Array.from(map.values()).map(g=>{
          const den = rateBaseDenominator(g);
          g.wr = den ? g.vendas/den : 0;
          g.lr = den ? g.perdidos/den : 0;
          return g;
        });
      }

      const groups = buildGroup().filter(g=>g.total>0);
      const best = groups.slice().sort((a,b)=> (b.wr-a.wr) || (b.total-a.total))[0];
      const worst = groups.slice().sort((a,b)=> (b.lr-a.lr) || (b.total-a.total))[0];

      const scopeLabel = (level === "regiao") ? "Região"
                        : (level === "uf") ? "Estado"
                        : "Microrregião";

      const autoCards = [];

      if(best){
        autoCards.push(makeAutoCard(
          "Destaque positivo",
          `${scopeLabel}: ${best.key}`,
          [
            { label:"Tx ganho", value: pct(best.wr), tip:"Taxa de ganho neste recorte. Use como referência para identificar padrões de sucesso replicáveis." },
            { label:"Volume", value: fmtInt(best.total), tip:"Volume de registros no recorte. Volume alto dá mais confiança na taxa." },
            { label:"Ganhas", value: fmtInt(best.vendas), tip:"Quantidade de vendas. Se alto, vale mapear playbook e replicar." },
            { label:"Perdidas", value: fmtInt(best.perdidos), tip:"Perdas no recorte. Mesmo em destaque, perdas podem indicar gargalos específicos." },
          ]
        ));
      }else{
        autoCards.push(emptyCard("Insights"));
      }

      if(worst){
        autoCards.push(makeAutoCard(
          "Destaque negativo",
          `${scopeLabel}: ${worst.key}`,
          [
            { label:"Tx perda", value: pct(worst.lr), tip:"Taxa de perda neste recorte. Priorize diagnóstico (qualificação, proposta, preço, timing)." },
            { label:"Volume", value: fmtInt(worst.total), tip:"Quanto maior o volume, mais importante agir rápido para reduzir perdas." },
            { label:"Perdidas", value: fmtInt(worst.perdidos), tip:"Total de perdas. Procure padrões por origem/canal e revise critérios." },
            { label:"Ganhas", value: fmtInt(worst.vendas), tip:"Mesmo em risco, vitórias mostram que existe caminho — identifique o que funcionou." },
          ]
        ));
      }else{
        autoCards.push(emptyCard("Insights"));
      }

      // Saúde do funil (com saldo explicado)
      const t = agg.totals;
      const den = rateBaseDenominator(t);
      const wr = den ? t.vendas/den : 0;
      const ar = (t.vendas + t.perdidos + t.andamento) ? (t.andamento / (t.vendas + t.perdidos + t.andamento)) : 0;
      const saldo = (t.vendas - t.perdidos);

      const periodLabel = (state.filters.month === "__all" && agg.months.length)
        ? `${formatMonthLabel(agg.months[0])} → ${formatMonthLabel(agg.months[agg.months.length-1])}`
        : (state.filters.month === "__all" ? "—" : formatMonthLabel(state.filters.month));

      autoCards.push(makeAutoCard(
        "Saúde do funil",
        "Fechamento, ativos e tendência",
        [
          { label:"Tx fechadas", value: pct(wr), tip:"Proporção de ganhas sobre a base selecionada. Útil para comparar recortes." },
          { label:"Tx ativas", value: pct(ar), tip:"Percentual em negociação (abertas) no recorte. Se alto, pode indicar funil travado." },
          { label:"Período", value: periodLabel, tip:"Janela de análise do recorte atual (com base no filtro de mês)." },
          { label:"Saldo (Ganhas − Perdidos)", value: (saldo>=0? "↑ " : "↓ ") + fmtInt(Math.abs(saldo)), tip:"Diferença entre ganhas e perdidas no período. Positivo = mais vitórias do que perdas (bom sinal de fechamento)." },
        ]
      ));

      renderTriGrid(oppTop, riskTop, autoCards);
    }

    function buildTableRows(agg){
      const rows = Array.from(agg.byCity.values()).map(r=>{
        const den = rateBaseDenominator(r);
        const wr = den ? r.vendas/den : 0;
        const lr = den ? r.perdidos/den : 0;
        return {
          regiao: r.regiao,
          uf: r.uf,
          microrregiao: r.microrregiao,
          cidade: r.cidade,
          total: Math.round(r.total),
          vendas: Math.round(r.vendas),
          perdidos: Math.round(r.perdidos),
          andamento: Math.round(r.andamento),
          txGanho: pct(wr),
          txPerda: pct(lr),
        };
      }).sort((a,b)=> b.total - a.total);

      state.tableAllRows = rows;
      renderTableFromState();
      applyThemeToTable();
    }

    /********************
     * Analyze flow (fix “processando/aguardando” preso)
     ********************/
    analyzeBtn.addEventListener("click", async ()=>{
      try{
        setUploadsStatus("warn", "Processando...", "aguarde");
        analyzeBtn.disabled = true;

        // internal map
        state.mapInternal = await parseInternalMapIfAny();

        let baseRows = [];
        const baseFile = baseFileInput.files?.[0];

        if(baseFile){
          baseRows = await readFileAsRows(baseFile);
        }else{
          // demo
          const resp = await fetch(ASSETS.demoCsv, {cache:"no-store"});
          if(!resp.ok) throw new Error("Não foi possível carregar a demo (verifique ./assets/demo/rd_demo.csv).");
          const text = await resp.text();
          baseRows = await new Promise((resolve, reject)=>{
            Papa.parse(text, {
              header:true,
              skipEmptyLines:true,
              complete:(res)=> resolve(normalizeRows(res.data)),
              error: reject
            });
          });
        }

        state.raw = baseRows;
        state.enriched = enrichBaseRows(baseRows, state.mapInternal);
        state.analyzed = true;

        // populate filters
        const months = Array.from(new Set(state.enriched.map(r=>r.month).filter(Boolean))).sort();
        fillSelect(monthFilter, months.map(m=>({value:m,label:formatMonthLabel(m)})), "Todos os meses");

        const regions = Array.from(new Set(state.enriched.map(r=>r.regiao).filter(Boolean))).sort();
        fillSelect(regionFilter, regions.map(r=>({value:r,label:r})), "Todas as regiões");

        const allUFs = Array.from(new Set(state.enriched.map(r=>r.uf).filter(Boolean))).sort();
        rebuildUFOptionsByRegion(regionFilter.value, allUFs);

        // reset filters default
        state.filters.month = "__all";
        state.filters.region = "__all";
        state.filters.uf = "__all";
        monthFilter.value = "__all";
        regionFilter.value = "__all";
        ufFilter.value = "__all";

        updateChartRegionClearUI(false);

        // render everything
        rerender();

        setUploadsStatus("ok", "Pronto", `${fmtInt(state.enriched.length)} registros`);
        // compactar uploads depois de analisar (melhora UX)
        setUploadsOpen(false);

      }catch(err){
        console.error(err);
        setUploadsStatus("bad", "Erro", err?.message || "Falha ao processar a base.");
      }finally{
        analyzeBtn.disabled = false;
        syncActionButtons();
      }
    });

    /********************
     * Initial empty state
     ********************/
    // Pre-fill filters placeholders
    fillSelect(monthFilter, [], "Todos os meses");
    fillSelect(regionFilter, [], "Todas as regiões");
    fillSelect(ufFilter, [], "Todos os estados");
    renderKPIs(null);
    ensureTable();
  </script>
</body>
</html>
